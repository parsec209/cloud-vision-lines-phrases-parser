# cloud-vision-lines-phrases-parser

Uses customizable parsers to find text located within OCR output. In this case, the OCR output is the line list object generated by the [cloud-vision-lines-phrases](https://www.npmjs.com/package/cloud-vision-lines-phrases) package, which itself is a modified version of the output from Google Cloud Vision's [small batch file annotation online](https://cloud.google.com/vision/docs/file-small-batch).

Check out a UI demo that uses this module in [CodeSandbox](https://githubbox.com/parsec209/cloud-vision-lines-phrases-parser-ui), as well as its repo [here](https://github.com/parsec209/cloud-vision-lines-phrases-parser-ui).

## Installation

```js
const { getParsersTarget } = require('cloud-vision-lines-phrases-parser')
```

## Use

```js
//Refer to the cloud-vision-lines-phrases package for further detail on this setup for generating the lineList object
const getAnnotationFormats = require('cloud-vision-lines-phrases')

const batchFileAnnotation = ['...'] 
const bucketFileBasename = 'filename'
const annotationFormats = getAnnotationFormats(batchFileAnnotation, bucketFileBasename);
const lineList = annotationFormats.lineList
```

```js
const parsers = [

  //parser #1 
  {
    count: 2  //any number
    method: 'after' //'after' or 'below',
    target: { 
      {
        pattern: '.+',  //use any pattern that you would input into a RegExp object's constructor function 
        unit: 'phrase',  //'phrase' or 'word'
      },
    },
  },

  //parser #2
  {
    count: 2  
    method: 'below' 
    target: {
      {
        pattern: '\\S{8}',  
        unit: 'word'  
      },
    },
  },

  //parser #3, etc.
]
```
The parsers array in the above example performs the following steps:

1) The first parser finds the `<2nd>` `<phrase>` `<after>` the `<beginning of the document>` that matches the pattern: `<.+>`

2) The second parser finds the `<2nd>` `<word>` `<below>` the `<previously parsed value>` that matches the pattern: `<.{8}>`

```js
//Now we can input the lineList and parsers array into the package's function
const targetTextObject = getParsersTarget(lineList, parsers)
```

And the object that is returned contains info about the text value, location within the line list, the bounding box coordinates, and its unit type: 

```js
{
  value: '2/1/2023',
  normalizedVertices: ['...'],
  indices: {
    pageEnd: 0, lineEnd: 3, phraseEnd: 1, wordEnd: 0
  },
  unitType: 'word', 
}
```

Looking at the image file (assume this snippet is the entire document), the first parser captures the yellow-highlighted value, and the second parser (starting its parse from this value) captures the blue-highlighted value which is ultimately the value that is returned:

![Alt text](img/parserExample.png?raw=true "parser-example")

More details about how the units are defined (_phrases_ and _words_) can be found in the [cloud-vision-lines-phrases](https://www.npmjs.com/package/cloud-vision-lines-phrases) package.

When selecting the _after_ method, think of this as parsing left to right across the page, and then down to the next line, just as you would read a page of text. More technically, the parser will iterate through one of the two unit types (either _phrase_ or _word_ per the  _target.unit_) until it finds a unit's text that matches the _target.pattern_. The  _count_ determines how many matching units it must find, and the last matching unit will be the returned value and the point where the parse terminates. If the count has not been met by the time the parser reaches the end of the line list, an empty value will be returned. Each parser will start at the unit where the previous parser ended, and the first parser will always start at the beginning of the line list (this applies to both the _after_ and _below_ methods, so it doesn't matter which of the two methods you select for the first parser). 

CAVEAT:
If a parser is capturing a word (yellow) that is embedded in the beginning or middle of a phrase, the next parser (if the selected _target.pattern_ is a _phrase_) will use the remainder of that phrase (blue) in its count :

![Alt text](img/parserExampleCaveat.png?raw=true "parser-caveat-example")

When the _below_ method is selected, the parser will go line by line _directly beneath_ the previous parser's stopping point until it finds a unit (either a _phrase_ or _word_ depending on the _target.unit_) with text matching the _target.pattern_. _Directly beneath_, in this context, means that a unit is in a line beneath, and horizontally overlaps, the previous parser's stopping point. When a matching unit is found, the count is incremented and the parse continues to go down to the next line _directly beneath_ the previous parser's stopping point and looks for another matching unit. This continues until either the count is met, which will return the last count's value, or the end of the line list is reached, which will return an empty value. The positions of the units stay relative to each other across multiple pages, i.e. text on subsequent pages is considered to be _directly beneath_ text on prior pages, as long as their x-coordinates overlap. 









